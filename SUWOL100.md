# SUWOL100 무인 계량 시스템 인터페이스 사양서

**문서 버전**: 1.0
**작성 일자**: 2026.02.09

---

## 1. 개요 (Overview)
본 문서는 `SUWOL100` (문서상 모델명 SUWOL-1000 호환) 무인 계량기의 하드웨어 인터페이스 제어를 위한 통신 규격 및 제어 전략을 기술한다.
본 시스템은 **PC 주도형(Master-Slave) 폴링 구조**를 가지며, 모든 하드웨어 제어권은 Gateway PC가 갖는다.

---

## 2. 통신 환경 (Connectivity)
* **Interface:** RS-232 Serial
* **Baudrate:** 9600 bps
* **Data Bits:** 8
* **Parity:** None
* **Stop Bits:** 1
* **Flow Control:** None

---

## 3. 시스템 아키텍처 및 제어 전략

### 3.1. 제어 주체: PC-Driven
MCU는 독자적인 판단 없이 PC의 요청(Request)에 따라 동작한다.
* **Display:** PC가 송신 패킷에 데이터를 실어 보내야만 전광판 내용이 갱신된다.
* **Voice:** PC가 음성 번호를 지정하여 보내야만 안내 방송이 송출된다.
* **Relay:** PC가 비트마스크 명령을 보내야만 외부 장치(릴레이)가 동작한다.

### 3.2. 데이터 수신: Polling 필수
장비는 **Single-Slot Mailbox** 구조를 가지며, 데이터 휘발성이 강하다.
* **1회 전송 후 클리어:** RFID 카드값과 키패드 입력값은 PC가 **1회 수신하는 즉시 MCU 버퍼에서 소멸**된다.
* **자동 클리어:** 사용자가 입력을 마쳐도 PC가 수신하지 않으면 **3초 후 데이터는 자동 소멸**된다.
* **결론:** PC는 사용자 입력 유실을 방지하기 위해 **지속적인 고속 Polling (Request-Response Loop)**을 수행해야 한다.

---

## 4. 기본 통신 프로토콜 (CMD: 'D')

### 4.1. Request (PC -> MCU) : 32 Bytes
PC가 MCU에게 상태를 질의하고 하드웨어를 제어하는 패킷.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1 | STX | `0x02` | Start of Text |
| 2 | ID | ASCII | 장비 번호 (0~9) |
| 3 | CMD | `'D'` | 기본 통신 커맨드 |
| **4~11** | **중량표시** | ASCII | **[Display]** 4번: 부호(+/-), 5~11번: 소수점 중량값 |
| **12~17** | **차량번호** | ASCII | **[Display]** 전광판 하단 표시 내용 (6자리) |
| 18~23 | 예비 | - | Reserved |
| **24~25** | **출력(Relay)** | **Hex Str** | **[Control]** 1~8번 릴레이 제어 (하단 5.1 참조) |
| **26~27** | **음성** | **Dec Str** | **[Control]** 안내 방송 송출 (01~99) |
| 28~31 | 예비 | - | Reserved |
| 32 | ETX | `0x03` | End of Text |

### 4.2. Response (MCU -> PC) : 53 Bytes
PC의 Request에 대한 응답으로, 현재 장비의 센서 및 입력 상태 스냅샷.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1~3 | Header | - | STX, ID, CMD 확인 |
| **4~11** | **CARD 값** | ASCII | **[Input]** RFID 태그 번호 (8자리) **(1회 전송 후 클리어됨)** |
| 12 | PIN | Char | 키패드 입력 구분 (N:차량, C:거래처, M:제품, P:전표재발행) |
| **13~18** | **키입력값** | ASCII | **[Input]** 사용자가 입력한 숫자 (6자리) **(1회 전송 후 클리어됨)** |
| 19~20 | 출력상태 | Hex Str | 현재 릴레이 동작 상태 피드백 |
| 21~22 | 입력센서 | - | 외부 입력 센서 상태 |
| **23~24** | **음성상태** | Dec Str | **[Busy Flag]** 현재 출력 중인 번호 표시 (`00`: 대기중) |
| **25~27** | **현재온도** | ASCII | 현재 내부 온도 (3자리) |
| 28~29 | 팬 설정값 | ASCII | 설정된 팬 작동 온도 |
| 30~31 | 히터 설정값 | ASCII | 설정된 히터 작동 온도 |
| **32** | **PS** | Char | **[Printer]** `0`:정상, `1`:용지없음, `2`:전송중 |
| 33~36 | 예비 | - | Reserved |
| **37~52** | **중량값** | ASCII | **[Scale]** 현재 중량 (Format: `ST,NT,+12345.6kg`) |
| 53 | ETX | `0x03` | End of Text |

---

## 5. 확장 제어 프로토콜 (Printer & Temp)

### 5.1. 프린터 출력 명령 (CMD: 'P')
PC에서 무인 계량기에 연결된 프린터로 텍스트를 전송한다.
**주의:** 기본 통신('D') 응답의 **32번 Byte(PS)**가 `0`(정상)일 때만 전송해야 한다.

* **Request Format:**
  `STX` + `ID` + `'P'` + `전송크기(4Byte)` + `수량(1Byte)` + `인쇄데이터(Variable)` + `ETX`
  * **전송크기:** 인쇄 데이터의 길이를 4자리 아스키 숫자로 전송 (예: 100바이트 -> "0100")
  * **수량:** 인쇄 매수 (1~9)

### 5.2. 온도 설정 명령 (CMD: 'T')
내부 팬(Fan)과 히터(Heater)의 동작 임계 온도를 설정한다.
* **Request Format:**
  `STX` + `ID` + `'T'` + `팬설정(2Byte)` + `히터설정(2Byte)` + `ETX`
  * **팬 설정:** `15` ~ `40` (도). `40` 이상 입력 시 강제 구동.
  * **히터 설정:** `00` ~ `15` (도). `15` 이상 입력 시 강제 차단.

---

## 6. 제어 구현 상세 (Implementation Detail)

### 6.1. 출력(Relay) 제어: Hex String 변환
8개의 릴레이를 제어하기 위해 비트마스크를 계산한 후, **2자리 16진수 문자열(ASCII)**로 변환하여 전송한다.
* **제어 가능:** 릴레이 1, 2, 3, 6, 7, 8 (용도는 현장 결선에 따름)
* **설정 불가:** 릴레이 4(팬), 5(히터)는 MCU 내부 온도 설정('T' 커맨드)에 의해 자동 제어됨.

**[비트 매핑 테이블]**
| 비트 | 릴레이 번호 | 제어 가능 여부 | 비고 |
| :--- | :--- | :--- | :--- |
| Bit 0 | Relay 1 | **O** | 사용자 정의 |
| Bit 1 | Relay 2 | **O** | 사용자 정의 |
| Bit 2 | Relay 3 | **O** | 사용자 정의 |
| Bit 3 | Relay 4 | X | **Fan (자동)** |
| Bit 4 | Relay 5 | X | **Heater (자동)** |
| Bit 5 | Relay 6 | **O** | 사용자 정의 |
| Bit 6 | Relay 7 | **O** | 사용자 정의 |
| Bit 7 | Relay 8 | **O** | 사용자 정의 |

**[예시]** Relay 1과 Relay 6을 동시에 켜는 경우
1.  비트 연산: `(1 << 0) | (1 << 5)` = `1 | 32` = `33`
2.  Hex 변환: `33` (Decimal) -> `0x21` (Hex)
3.  전송 데이터: 문자열 `"21"` (Bytes: `b'21'`)

### 6.2. 음성 제어: Decimal String
* **포맷:** 10진수 숫자를 2자리 문자열로 변환하여 전송 (예: 5번 -> `"05"`, 12번 -> `"12"`).
* **범위:** `01` ~ `99` (파일 번호).
* **Busy Check:** Response의 **23~24번(음성상태)** 바이트가 `"00"`일 때만 새로운 음성 명령을 전송해야 함.

---

## 7. 개발 시 필수 확인 사항 (Checkpoints)

1.  **데이터 유실 방지 (Critical)**
    * MCU의 입력 버퍼(RFID, 키패드)는 PC가 읽어가는 순간 비워지거나, 일정 시간(3초) 후 자동 소멸됨.
    * 따라서 PC 어플리케이션은 **Main Loop에서 딜레이를 최소화하여 지속적으로 Polling**해야 함.

2.  **프린터 상태 체크**
    * 프린터 명령('P')을 보내기 전 반드시 'D' 커맨드의 응답값 중 **32번(PS)** 바이트를 확인해야 함.
    * `PS`값이 `2`(전송중)이거나 `1`(용지없음)일 때 데이터를 보내면 통신 에러가 발생할 수 있음.

3.  **릴레이 4, 5번 제어 불가**
    * 4번(팬), 5번(히터) 릴레이는 PC에서 직접 ON/OFF 할 수 없으며, 오직 'T' 커맨드를 통한 온도 설정값에 의해서만 MCU가 자동으로 제어함.
