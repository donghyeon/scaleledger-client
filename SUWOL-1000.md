# `SUWOL-1000` 무인 계량 시스템 인터페이스 사양서

**문서 버전**: 1.2
**작성 일자**: 2026.02.12
**대상 장비**: SUWOL-1000 (Firmware Compat: SUW-1000)

---

## 1. 개요 (Overview)
본 문서는 `SUWOL-1000` 무인 계량 인디케이터와 Gateway PC 간의 RS-232 통신 프로토콜을 정의합니다.
본 시스템은 **PC가 주도권을 갖는 Master-Slave 폴링(Polling) 구조**이며, 계량 데이터 수신과 동시에 신호등(Signal Tower) 및 음성 안내를 제어해야 합니다.

---

## 2. 통신 환경 (Connectivity)
* **Interface:** RS-232 Serial
* **Baudrate:** 9600 bps
* **Data Bits:** 8
* **Parity:** None
* **Stop Bits:** 1
* **Flow Control:** None

---

## 3. 시스템 아키텍처 및 제어 전략

### 3.1. 제어 주체: PC-Driven
MCU는 독자적인 판단 없이 PC의 요청(Request)에 따라 동작합니다.
* **Display:** PC가 송신 패킷에 데이터를 실어 보내야만 전광판 내용이 갱신됩니다.
* **Traffic Control:** PC가 릴레이 비트를 제어하여 진입/진출 신호등(적/녹)을 직접 조작합니다.
* **Voice:** PC가 음성 번호를 지정하여 보내야만 안내 방송이 송출됩니다.

### 3.2. 데이터 수신: Polling 필수
장비는 **Single-Slot Mailbox** 구조를 가지며, 데이터 휘발성이 강합니다.
* **Input Volatility:** RFID 및 키패드 입력값은 PC가 **1회 수신 즉시, 또는 3초 경과 시 자동 소멸**됩니다.
* **Polling Cycle:** 사용자 입력 유실 방지를 위해 **100ms~200ms 주기의 고속 Polling**을 권장합니다.
---

## 4. 기본 통신 프로토콜 (CMD: 'D')

### 4.1. Request (PC -> MCU) : 32 Bytes
PC가 MCU에게 상태를 질의하고 하드웨어를 제어하는 패킷입니다.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1 | STX | `0x02` | Start of Text |
| 2 | ID | ASCII | 장비 번호 (0~9) |
| 3 | CMD | `'D'` | 기본 통신 커맨드 |
| **4~11** | **중량표시** | ASCII | **[Display]** 4번: 부호(+/-), 5~11번: 소수점 중량값 |
| **12~17** | **차량번호** | ASCII | **[Display]** 전광판 하단 표시 내용 (6자리) |
| 18~23 | 예비 | - | Reserved |
| **24~25** | **출력(Relay)** | **Hex Str** | **[Control]** 신호등 제어 (상세 6.1 참조) |
| **26~27** | **음성** | **Dec Str** | **[Control]** 안내 방송 송출 (01~12, 상세 6.2 참조) |
| 28~31 | 예비 | - | Reserved |
| 32 | ETX | `0x03` | End of Text |

### 4.2. Response (MCU -> PC) : 53 Bytes
PC의 Request에 대한 응답이며, 현재 장비의 센서 및 입력 상태 스냅샷입니다.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1~3 | Header | - | STX, ID, CMD 확인 |
| **4~11** | **CARD 값** | ASCII | **[Input]** RFID 태그 번호 (8자리) **(수신 후 소멸)** |
| 12 | PIN | Char | 키패드 입력 구분 (N:차량, C:거래처, M:제품, P:전표재발행) |
| **13~18** | **키입력값** | ASCII | **[Input]** 사용자 입력 숫자 (6자리) **(수신 후 소멸)** |
| **19~20** | **출력상태** | Hex Str | **[Status]** 현재 릴레이(신호등, 팬, 히터) 동작 상태 피드백 |
| 21~22 | 입력센서 | - | 외부 입력 센서 상태 |
| **23~24** | **음성상태** | Dec Str | **[Busy Flag]** 현재 출력 중인 번호 (`00`: Idle) |
| **25~27** | **현재온도** | ASCII | 현재 내부 온도 (3자리) |
| 28~29 | 팬 설정값 | ASCII | 설정된 팬 작동 온도 |
| 30~31 | 히터 설정값 | ASCII | 설정된 히터 작동 온도 |
| **32** | **PS** | Char | **[Printer]** `0`:정상, `1`:용지없음, `2`:전송중 |
| 33~36 | 예비 | - | Reserved |
| **37~52** | **중량값** | ASCII | **[Scale]** 현재 중량 (Format: `ST,NT,+12345.6kg`) |
| 53 | ETX | `0x03` | End of Text |

---

## 5. 확장 제어 프로토콜 (Printer & Temp)

### 5.1. 프린터 출력 명령 (CMD: 'P')
PC에서 무인 계량기에 연결된 프린터로 텍스트 데이터를 전송합니다.
**주의:** 기본 통신('D') 응답의 **32번 Byte(PS)**가 `0`(정상)일 때만 전송해야 합니다.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1 | STX | `0x02` | Start of Text |
| 2 | ID | ASCII | 장비 번호 (0~9) |
| 3 | CMD | `'P'` | 프린터 출력 커맨드 |
| **4~7** | **전송크기** | ASCII (4) | 인쇄 데이터의 길이 (Max 4000 Byte)<br>(예: 100 Byte → `"0100"`) |
| **8** | **수량** | ASCII (1) | 인쇄 매수 설정 (`1`~`9`) |
| **9~N** | **인쇄데이터** | Variable | 실제 프린터로 전송될 문자열 데이터 |
| N+1 | ETX | `0x03` | End of Text |

### 5.2. 온도 설정 명령 (CMD: 'T')
내부 팬(Fan)과 히터(Heater)의 동작 임계 온도를 설정합니다. 총 8 Byte 고정 길이 패킷입니다.

| Byte Index | 항목 | 포맷 | 설명 |
| :--- | :--- | :--- | :--- |
| 1 | STX | `0x02` | Start of Text |
| 2 | ID | ASCII | 장비 번호 (0~9) |
| 3 | CMD | `'T'` | 온도 설정 커맨드 |
| **4~5** | **팬 설정** | ASCII (2) | 팬 동작 온도 설정 (`15`~`40`)<br>**※ 40 이상 입력 시 강제 구동** |
| **6~7** | **히터 설정** | ASCII (2) | 히터 동작 온도 설정 (`00`~`15`)<br>**※ 15 이상 입력 시 강제 차단** |
| 8 | ETX | `0x03` | End of Text |

---

## 6. 제어 구현 상세 (Implementation Detail)

### 6.1. 출력(Relay) 제어 및 상태 모니터링
Relay 제어는 각 릴레이에 할당된 값을 더하여 2자리 문자열로 전송하는 방식을 사용합니다. **Request(제어)**와 **Response(상태 확인)**에서 유효한 릴레이 항목이 다르므로 주의가 필요합니다.

* **포맷:** Hex String (2 Bytes). (예: Relay 1 켜기 -> `"01"`, Relay 1, 2 모두 켜기 -> `"03"`)

#### [Relay Map Definition]
* **제어(Request):** PC는 `Relay 1`, `Relay 2`를 통해 신호등을 제어합니다. 팬/히터 제어값은 무시됩니다.
* **상태(Response):** MCU는 `Relay 4`, `Relay 5`를 통해 현재 팬/히터의 작동 여부를 보고합니다.

| Relay No | Hex Value | 기능 (Function) | 제어(Request) | 상태(Response) | 비고 |
| :---: | :---: | :--- | :---: | :---: | :--- |
| **Relay 1** | `0x01` | **Green Light** | **ON/OFF** | ON/OFF | **점멸 동작 (Blinking)** |
| **Relay 2** | `0x02` | **Red Light** | **ON/OFF** | ON/OFF | **점멸 동작 (Blinking)** |
| Relay 3 | `0x04` | Spare | - | - | 미사용 |
| **Relay 4** | `0x08` | **Fan** | N/A | **Status Only** | 온도 설정('T')에 의해 자동 제어 |
| **Relay 5** | `0x10` | **Heater** | N/A | **Status Only** | 온도 설정('T')에 의해 자동 제어 |
| Relay 6~8 | `0x20`~`0x80`| Spare | - | - | 미사용 |

**[제어 예시]**
* **녹색등(진입허가) 켜기:** Relay 1 값 적용 -> Hex `"01"` 전송.
* **적색등(진입금지) 켜기:** Relay 2 값 적용 -> Hex `"02"` 전송.
* **모두 끄기:** Hex `"00"` 전송.

### 6.2. 음성 안내 제어 (Voice Control)
지정된 인덱스(`01`~`12`) 외의 값을 전송할 경우 무시되거나 예기치 않은 동작을 할 수 있습니다.

* **포맷:** Decimal String (2 Bytes), 예: `"05"`
* **주의사항 (Field Note):** 일부 음원 파일의 경우 녹음 품질 이슈(노이즈, 발음)가 존재하므로, 현장 적용 시 볼륨 조절 및 사용자 교육이 필요할 수 있습니다.

**[음원 리스트 (Audio Mapping)]**

| ID | 내용 (Script) | 비고 (Field Description) |
| :--- | :--- | :--- |
| **01** | 계량이 끝났습니다. | 정상 완료 메시지 |
| **02** | 잠시 대기하십시오. | - |
| **03** | 잠시만 기다려주십시오. | - |
| **04** | 카드를 대어주십시오. | **[Caution]** 노이즈 심함 (Rough sound) |
| **05** | 인디케이터 이상입니다. | **[Caution]** '인디케이터' 발음 불명확 |
| **06** | 과적입니다. | **[Caution]** 노이즈 심함 |
| **07** | 관리자에게 확인하십시오. | - |
| **08** | 등록되지 않은 카드입니다. | 카드 에러 |
| **09** | 삐삐삐삐삐 | 단순 경고음 (Buzzer) |
| **10** | 시스템 이상입니다. 잠시만 기다려주십시오. | 시스템 에러 |
| **11** | 이용해주셔서 감사합니다. | **[Sound]** 밝은 멜로디 (Exit BGM) |
| **12** | 찌잉 (Effect) | **[Sound]** 강한 경고음/개방 알림 |
| 13~99 | (Empty) | 음원 없음 |

---

## 7. 개발 시 필수 확인 사항 (Checkpoints)

1.  **데이터 유실 방지 (Critical)**
    * MCU의 입력 버퍼(RFID, 키패드)는 PC가 읽어가는 순간 비워지거나, 일정 시간(3초) 후 자동 소멸됩니다.
    * 따라서 PC 어플리케이션은 **Main Loop에서 딜레이를 최소화하여 지속적으로 Polling**해야 합니다.

2.  **프린터 상태 체크**
    * 프린터 명령('P')을 보내기 전 반드시 'D' 커맨드의 응답값 중 **32번(PS)** 바이트를 확인해야 합니다.
    * `PS`값이 `2`(전송중)이거나 `1`(용지없음)일 때 데이터를 보내면 통신 에러가 발생할 수 있습니다.

3.  **릴레이 4, 5번 제어 불가**
    * 4번(팬), 5번(히터) 릴레이는 PC에서 직접 ON/OFF 할 수 없으며, 오직 'T' 커맨드를 통한 온도 설정값에 의해서만 MCU가 자동으로 제어합니다.
